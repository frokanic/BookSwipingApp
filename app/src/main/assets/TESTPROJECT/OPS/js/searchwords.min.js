/* Prject: AZARDI event Education Library
Module: Cross Words for K-12
Created by: Milan Bishwakarma
Version: 0.0.1
Copyright 2013 Infogrid Pacific. All rights reserved.
*/
var AIEL = AIEL || {};
AIEL.searchwords = {
	settings: {},
	userdata: {},
	init:function(){
		$('.searchwords-i-rw').find('table td').each(function(){
			var txt = $.trim($(this).text());
			if(txt == '') {
				$(this).addClass('block');
			} 
		});
		
		AIEL.searchwords.generateIDs();
		
		//AIEL.searchwords.searchwordsAsignment();
		
		AIEL.searchwords.searchwordsetup();
		AIEL.searchwords.eventHandler();
		
		AIEL.searchwords.UserResultStorage.init();
	},
	constructsearchwordsRelationship:function(ID){
		var confg = $('#'+ID).find('.searchwords-setup li').text();
		var rel = confg.split('],');
		var rel_fix = [];
		for (var i = 0; i < rel.length; i++) {
			AIEL.searchwords.settings[ID].words.push($.trim(rel[i].split('[')[0]));
			var rel_num = rel[i];
			var rel_num_splt = rel_num.split('[')[1];
			rel_num_splt = rel_num_splt.replace(']','');
			rel_fix = rel_num_splt.split(',');
			for (var j = 0; j < rel_fix.length; j++) {
				if (rel_fix[0] == rel_fix[1]-1) {
					$('#'+ID+'__td__'+$.trim(rel_fix[j])).attr('data-rel-x', rel_fix);
				} else {
					$('#'+ID+'__td__'+$.trim(rel_fix[j])).attr('data-rel-y', rel_fix);
				}
			}
		}
		AIEL.searchwords.settings[ID].result = rel.length;
		$('#'+ID).find('.score-board .sw-total').text(rel.length);
	},
	searchwordsetup:function(){
		$('.searchwords-i-rw').each(function(){
			//.auto-event-i-rw
			var ID = $(this).attr('id');
			AIEL.searchwords.settings[ID] = {
				'editNav': [],
				'result': 0,
				'mode': 'learning',
				'score': 0,
				'attempts': 0,
				'marks': 0,
				'relX': '',
				'relY': '',
				'selected': [],
				'firstClick': false,
				'secondClick': false,
				'direction': 'down',
				'words': [],
				'alreadySearched': false,
			}
			AIEL.searchwords.settings[ID].mode = $(this).hasClass('mode-learning') ? 'learning':'test';
			AIEL.searchwords.constructsearchwordsRelationship(ID);
		});
	},
	eventHandler:function(){
		
		$(document).on('click', '.searchwords-i-rw table td:not(td.block)', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			var ele = $(this);
			AIEL.searchwords.findWord(ID, ele);
		});
		
		$(document).on('click', '.searchwords-i-rw .searchwords-word', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			AIEL.searchwords.buildWord(ID);
		});
		
		$(document).on('click', '.searchwords-i-rw .searchwords-reset', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			$('#'+ID).find('td').removeClass('correct wrong selected highlight');
			$('#'+ID).find('.word-lists').find('ol').html('');
			delete AIEL.searchwords.userdata[ID];
			AIEL.searchwords.settings[ID].firstClick = false;
			AIEL.searchwords.settings[ID].secondClick = false;
			AIEL.searchwords.settings[ID].selected = [];
			AIEL.searchwords.settings[ID].score = 0;
			AIEL.searchwords.settings[ID].attempts = 0;
			AIEL.searchwords.settings[ID].marks = 0;
			
			$('#'+ID).find('.score-board').find('.sw-correct').text(0);
			$('#'+ID).find('.score-board').find('.sw-wrong').text(0);
			$('#'+ID).find('.score-board').find('.sw-marks').text('0%');
			//update marked/highlighted words
			$('#'+ID).find('.score-board .sw-marked').text(0);
			
			$('#'+ID).find('.feedback-messages').hide();
			$('#'+ID).find('.highlight').removeClass('highlight-rel highlight across down');
			
			$('#'+ID).find('.buttons-rw').find('.searchwords-word, .searchwords-clear').removeAttr('disabled');
			//$('#'+ID).find('.buttons-rw').find('.searchwords-try-again, .searchwords-check, .searchwords-reset').attr('disabled', 'disabled');
			
			AIEL.searchwords.UserResultStorage.saveUserResult();
		});
		
		$(document).on('click', '.searchwords-i-rw .searchwords-try-again', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			AIEL.searchwords.tryAgain(ID);
		});
		
		$(document).on('click', '.searchwords-i-rw .searchwords-check', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			AIEL.searchwords.evaluateUserEvent(ID);
			AIEL.searchwords.UserResultStorage.saveUserResult();
		});
		
		$(document).on('click', '.searchwords-i-rw .searchwords-clear', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			$('#'+ID).find('td.highlight').removeClass('highlight');
			$('#'+ID).find('.word-lists ol').remove();
		});
		
		$(document).on('click', '.searchwords-i-rw .word-lists li', function(){
			var ID = $(this).parents('.searchwords-i-rw').attr('id');
			var ids = $(this).attr('data-id').split(',');
			var cur = $(this).attr('data-seq');
			$(this).parents('.word-lists').find('li:not([data-seq="'+cur+'"])').removeClass('linking');
			$('#'+ID).find('td').removeClass('selected');
			var link_show = false;
			if($(this).hasClass('linking')) {
				$(this).removeClass('linking');
				link_show = false;
			} else {
				$(this).addClass('linking');
				link_show = true;
			}
			for (var i=0;i<ids.length;i++) {
				var op = $.trim(ids[i]);
				if(link_show) {
					$('#'+ID+'__td__'+op).addClass('selected');
				} else {
					$('#'+ID+'__td__'+op).removeClass('selected');
				}
			}
		});
		
		
	},
	searchwordsEvent:function(ID, event){
		if(AIEL.searchwords.settings[ID].multiChoice) {
			$(event).parents('p, li').find('span').removeClass('selected-aie correct wrong');
			$(event).addClass('selected-aie');
		} else {
			$(event).removeClass('correct wrong');
			$(event).toggleClass('selected-aie');
		}
		if(AIEL.searchwords.settings[ID].evaluate) {
			AIEL.searchwords.evaluateEvent(ID, event);
		}
	},
	findWord:function(ID, obj){
		$('#'+ID).find('.word-lists').find('li.linking').trigger('click');
		
		if(($(obj).hasClass('correct') || $(obj).hasClass('wrong')) && AIEL.searchwords.settings[ID].alreadySearched) {
			if($(obj).hasClass('selected')) {
				$(obj).removeClass('selected');
				AIEL.searchwords.settings[ID].alreadySearched = false;
				return false;
			} else {
				alert("You're cheating :-(");
				return false;
			}
		}
		
		if($(obj).hasClass('correct') || $(obj).hasClass('wrong')) {
			if($(obj).hasClass('selected')==false) {
				AIEL.searchwords.settings[ID].alreadySearched = true;
			}
		} else {
			if($(obj).hasClass('selected')==false) {
				AIEL.searchwords.settings[ID].alreadySearched = false;
			}
		}
		
		var sel = $(obj).attr('id').split('__');
		sel = sel[sel.length-1];
		if($(obj).hasClass('selected') == false) {
			$(obj).addClass('selected');
			AIEL.searchwords.settings[ID].selected.push(sel);
		} else {
			$(obj).removeClass('selected');
			var new_ar = AIEL.searchwords.settings[ID].selected;
			var indx = new_ar.indexOf(sel);
			new_ar.splice(indx, 1);
			AIEL.searchwords.settings[ID].selected = new_ar;
			return false;
		}
		if(AIEL.searchwords.settings[ID].firstClick && !AIEL.searchwords.settings[ID].secondClick) {
			AIEL.searchwords.settings[ID].secondClick = true;
			var relx = AIEL.searchwords.settings[ID].relX.split(',');
			AIEL.searchwords.settings[ID].direction = 'down';
			for (var i=0;i<relx.length;i++) {
				var op = $.trim(relx[i]);
				if(sel==op) {
					AIEL.searchwords.settings[ID].direction = 'across';
					return false;
				}
			}
		}
		if(!AIEL.searchwords.settings[ID].firstClick) {
			var relx = $(obj).attr('data-rel-x')?$(obj).attr('data-rel-x'):'none';
			var rely = $(obj).attr('data-rel-y')?$(obj).attr('data-rel-y'):'none';
			AIEL.searchwords.settings[ID].relX = relx;
			AIEL.searchwords.settings[ID].relY = rely;
			AIEL.searchwords.settings[ID].firstClick = true;
		}
		
	},
	buildWord:function(ID){
		if(AIEL.searchwords.settings[ID].selected.length!=0) {
			var sel_word = '';
			var cor_wordx = '';
			var cor_wordy = '';
			var sel_cells = AIEL.searchwords.settings[ID].selected.sort();
			sel_cells = sel_cells.sort(function (a, b) { 
			    return a - b;
			});
			for (var i=0;i<sel_cells.length;i++) {
				sel_word = sel_word+$('#'+ID+'__td__'+sel_cells[i]).text();
			}
			
			if (AIEL.searchwords.userdata && (AIEL.searchwords.userdata.hasOwnProperty(ID) == false)) {
				AIEL.searchwords.userdata[ID]= {};
			}
			
			var correct_word = '';
			var words = AIEL.searchwords.settings[ID].words;
			for(var i=0;i<words.length;i++) {
				if(sel_word == words[i]) {
					correct_word=words[i];
					break;
				}
			}
			$('#'+ID).find('.selected').addClass('highlight').removeClass('selected');
			if($('#'+ID).find('.word-lists').find('ol').length<1) {
				$('#'+ID).find('.word-lists').append('<ol></ol>');
			}
			var li_len = $('#'+ID).find('.word-lists').find('li').length;
			var lis = '<li data-seq="'+li_len+'" data-id="'+sel_cells+'" data-word="'+correct_word+'">'+sel_word+'</li>';
			$('#'+ID).find('.word-lists').find('ol').append(lis);
			AIEL.searchwords.settings[ID].firstClick = false;
			AIEL.searchwords.settings[ID].secondClick = false;
			AIEL.searchwords.settings[ID].selected = [];
			AIEL.searchwords.settings[ID].alreadySearched = false;
			
			//update marked/highlighted words
			$('#'+ID).find('.score-board .sw-marked').text($('#'+ID).find('.word-lists').find('ol li').length);
			
			// enable evaluation buttons
			if(words.length == $('#'+ID).find('.word-lists').find('ol li').length) {
				//$('#'+ID).find('.buttons-rw .searchwords-check').removeAttr('disabled');
				$('#'+ID).find('.buttons-rw').find('.searchwords-word, .searchwords-clear').attr('disabled', 'disabled');
			}
		} 
	},
	scoreCalc:function(ID){
		var total = AIEL.searchwords.settings[ID].result;
		var score = AIEL.searchwords.settings[ID].score;
		var attempts = AIEL.searchwords.settings[ID].attempts;
		var marks = Math.round((score/total)*100);
		//if(AIEL.searchwords.settings[ID].mode == 'learning') {
			//marks = Math.round((score-attempts)/total*100);
		//} else {
			//marks = Math.round((score/total)*100);
		//}
		marks = marks+'%';
		$('#'+ID).find('.score-board .sw-correct').text(score);
		$('#'+ID).find('.score-board .sw-wrong').text(attempts);
		$('#'+ID).find('.score-board .sw-marks').text(marks);
		$('#'+ID).find('.score-board .sw-total').text(total);
		//update marked/highlighted words
		$('#'+ID).find('.score-board .sw-marked').text(score+attempts);
		//AIEL.searchwords.userdata[ID].scores = {'score':score, 'attempts':attempts, 'marks':marks};
		
	},
	generateIDs:function(){
		$('.searchwords-i-rw').each(function(i){
			var par_id = 'sw__'+(i+1);
			var old_id = $(this).attr('id');
			if(!old_id) {
				$(this).attr('id', par_id);
			}
			var objid = $(this).attr('id');
			$(this).find('table td').each(function(i){
				var spn_id = objid+'__'+'td__'+(i+1);
				$(this).attr('id',spn_id);
			});
		});
	},
	checkIfFinished:function(ID){
		var total = AIEL.searchwords.settings[ID].result;
		var correct = AIEL.searchwords.settings[ID].score;
		var wrong = AIEL.searchwords.settings[ID].attempts;
		var completed = correct+wrong;
		if(total == correct) {
			$('#'+ID).find('.feedback-messages').show();
			$('#'+ID).find('.feedback-messages .fbm-correct').show();
			$('#'+ID).find('.feedback-messages .fbm-wrong').hide();
		} else {
			$('#'+ID).find('.feedback-messages').show();
			$('#'+ID).find('.feedback-messages .fbm-wrong').show();
			$('#'+ID).find('.feedback-messages .fbm-correct').hide();
			// enable try-again button
			//$('#'+ID).find('.buttons-rw .searchwords-try-again').removeAttr('disabled');
		}
	},
	evaluateUserEvent:function(ID) {
		$('#'+ID).find('.word-lists').find('li:not(.correct, .wrong)').each(function(i){
			var ans_word = $(this).attr('data-word');
			var usr_word = $.trim($(this).text());
			var seq = $(this).attr('data-seq');
			var cls = '';
			if(ans_word == usr_word) {
				$(this).addClass('correct');
				cls = 'correct';
				AIEL.searchwords.settings[ID].score = AIEL.searchwords.settings[ID].score+1;
			} else {
				$(this).addClass('wrong');
				cls = 'wrong';
				AIEL.searchwords.settings[ID].attempts = AIEL.searchwords.settings[ID].attempts+1;
			}
			var ids = $(this).attr('data-id').split(',');
			for(var i=0;i<ids.length;i++) {
				$('#'+ID+'__td__'+$.trim(ids[i])).addClass(cls).removeClass('highlight');
			}
			ids.push(usr_word);
			AIEL.searchwords.userdata[ID][ans_word+'_'+seq] = ids;
			//alert(JSON.stringify(AIEL.searchwords.userdata));
		});
		
		// enable reset button
		//$('#'+ID).find('.buttons-rw .searchwords-reset').removeAttr('disabled');
		$('#'+ID).find('.buttons-rw').find('.searchwords-word, .searchwords-clear').attr('disabled', 'disabled');
		
		AIEL.searchwords.scoreCalc(ID);
		AIEL.searchwords.checkIfFinished(ID);
		
	},
	tryAgain:function(ID){
		$('#'+ID).find('.word-lists').find('ol').find('li.wrong').each(function(){
			var obj_id = $(this).attr('data-word')+'_'+$(this).attr('data-seq');
			delete AIEL.searchwords.userdata[ID][obj_id];
		});
		AIEL.searchwords.settings[ID].attempts = 0;
		$('#'+ID).find('.score-board').find('.sw-wrong').text(0);
		$('#'+ID).find('td.wrong').removeClass('wrong selected highlight');
		$('#'+ID).find('.word-lists').find('ol').find('li.wrong').remove();
		
		$('#'+ID).find('.feedback-messages').hide();
		
		//update marked/highlighted words
		$('#'+ID).find('.score-board .sw-marked').text($('#'+ID).find('.word-lists').find('ol li').length);
		
		$('#'+ID).find('.buttons-rw').find('.searchwords-word, .searchwords-clear').removeAttr('disabled');
		//$('#'+ID).find('.buttons-rw').find('.searchwords-try-again, .searchwords-check, .searchwords-reset').attr('disabled', 'disabled');
		AIEL.searchwords.UserResultStorage.saveUserResult();
	},
}

AIEL.searchwords.UserResultStorage = {
	init: function() {
		AIEL.searchwords.UserResultStorage.loadUserResult();
	},
	
	getUniqueName: function() {
		// we have local storage saving problem on the AZARDI IOS Reader from ACF
		var acf_bookid = '';
		try {
			acf_bookid = key; // key variable is not defined on this js, this defined on iOS reader of ACF and it mean to give Book ID and Account ID
		} catch(e) {
			acf_bookid = 'AIEL_searchwords';
		}
		var path = window.location.pathname;
		var solitnames = path.split('/');
		var pagename = solitnames[solitnames.length-1];
		var uniquename = pagename + "::" + acf_bookid;
		return uniquename;
	},
	
	// Function to store the result of the user in local storage
	 saveUserResult: function() {
		var uname = this.getUniqueName();
		//AIEL.searchwords.userdata = {};
		//alert(JSON.stringify(AIEL.searchwords.userdata));
		localStorage.setItem(uname, JSON.stringify(AIEL.searchwords.userdata));
		return;
	 },
	 
	 // Function to load the result of the user from local storage 
	 loadUserResult: function() {
		var uname = this.getUniqueName();
		var retrievedObject = localStorage.getItem(uname);
		var user_objects = JSON.parse(retrievedObject);
		AIEL.searchwords.userdata = user_objects;
		if ($.isEmptyObject(user_objects) == false) {
			var ID = '';
			var scorescard = {};
			for (item in user_objects) {
				ID = item;
				scorescard = user_objects[item].scores;
				var objects = user_objects[item];
				for (td in objects) {
					if(td == 'scores') {
						
					} else {
						var ele = td;
						var obj = objects[td];
						var objx = obj.pop();
						if($('#'+ID).find('.word-lists').find('ol').length<1) {
							$('#'+ID).find('.word-lists').append('<ol></ol>');
						}
						var obj_id = ele.split('_');
						var lis = '<li data-seq="'+obj_id[1]+'" data-id="'+obj+'" data-word="'+obj_id[0]+'">'+objx+'</li>';
						$('#'+ID).find('.word-lists').find('ol').append(lis);
					}
				}
			}
			AIEL.searchwords.evaluateUserEvent(ID);
		} else {
			AIEL.searchwords.userdata = {};
		}
		return;
	},
}

$(document).ready(function(){
	if($('.searchwords-i-rw').length > 0 ) {
		AIEL.searchwords.init();
	}
});